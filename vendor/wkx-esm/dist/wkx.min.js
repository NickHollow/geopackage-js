!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.wkx={})}(this,function(t){"use strict";const e={Point:"POINT",LineString:"LINESTRING",Polygon:"POLYGON",MultiPoint:"MULTIPOINT",MultiLineString:"MULTILINESTRING",MultiPolygon:"MULTIPOLYGON",GeometryCollection:"GEOMETRYCOLLECTION"},r={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6,GeometryCollection:7},i={Point:"Point",LineString:"LineString",Polygon:"Polygon",MultiPoint:"MultiPoint",MultiLineString:"MultiLineString",MultiPolygon:"MultiPolygon",GeometryCollection:"GeometryCollection"};function n(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}function o(t,e){this.buffer=new Buffer(t),this.position=0,this.allowResize=e}function s(t,e){return function(r,i){this.ensureSize(e),t.call(this.buffer,r,this.position,i),this.position+=e}}function a(t){return t<<1^t>>31}function h(t){return t>>1^-(1&t)}function p(t,e,r,i,n){v.call(this),this.x=t,this.y=e,this.z=r,this.m=i,this.srid=n,this.hasZ=void 0!==this.z,this.hasM=void 0!==this.m}function u(t,e){v.call(this),this.points=t||[],this.srid=e,this.points.length>0&&(this.hasZ=this.points[0].hasZ,this.hasM=this.points[0].hasM)}function c(t,e,r){v.call(this),this.exteriorRing=t||[],this.interiorRings=e||[],this.srid=r,this.exteriorRing.length>0&&(this.hasZ=this.exteriorRing[0].hasZ,this.hasM=this.exteriorRing[0].hasM)}function f(t,e){v.call(this),this.points=t||[],this.srid=e,this.points.length>0&&(this.hasZ=this.points[0].hasZ,this.hasM=this.points[0].hasM)}function g(t,e){v.call(this),this.lineStrings=t||[],this.srid=e,this.lineStrings.length>0&&(this.hasZ=this.lineStrings[0].hasZ,this.hasM=this.lineStrings[0].hasM)}function l(t,e){v.call(this),this.polygons=t||[],this.srid=e,this.polygons.length>0&&(this.hasZ=this.polygons[0].hasZ,this.hasM=this.polygons[0].hasM)}function d(t,e){v.call(this),this.geometries=t||[],this.srid=e,this.geometries.length>0&&(this.hasZ=this.geometries[0].hasZ,this.hasM=this.geometries[0].hasM)}function w(t,e){this.buffer=t,this.position=0,this.isBigEndian=e||!1}function y(t,e,r){return function(){var i;return i=this.isBigEndian?e.call(this.buffer,this.position):t.call(this.buffer,this.position),this.position+=r,i}}function M(t){this.value=t,this.position=0}function v(){this.srid=void 0,this.hasZ=!1,this.hasM=!1}o.prototype.writeUInt8=s(Buffer.prototype.writeUInt8,1),o.prototype.writeUInt16LE=s(Buffer.prototype.writeUInt16LE,2),o.prototype.writeUInt16BE=s(Buffer.prototype.writeUInt16BE,2),o.prototype.writeUInt32LE=s(Buffer.prototype.writeUInt32LE,4),o.prototype.writeUInt32BE=s(Buffer.prototype.writeUInt32BE,4),o.prototype.writeInt8=s(Buffer.prototype.writeInt8,1),o.prototype.writeInt16LE=s(Buffer.prototype.writeInt16LE,2),o.prototype.writeInt16BE=s(Buffer.prototype.writeInt16BE,2),o.prototype.writeInt32LE=s(Buffer.prototype.writeInt32LE,4),o.prototype.writeInt32BE=s(Buffer.prototype.writeInt32BE,4),o.prototype.writeFloatLE=s(Buffer.prototype.writeFloatLE,4),o.prototype.writeFloatBE=s(Buffer.prototype.writeFloatBE,4),o.prototype.writeDoubleLE=s(Buffer.prototype.writeDoubleLE,8),o.prototype.writeDoubleBE=s(Buffer.prototype.writeDoubleBE,8),o.prototype.writeBuffer=function(t){this.ensureSize(t.length),t.copy(this.buffer,this.position,0,t.length),this.position+=t.length},o.prototype.writeVarInt=function(t){for(var e=1;0!=(4294967168&t);)this.writeUInt8(127&t|128),t>>>=7,e++;return this.writeUInt8(127&t),e},o.prototype.ensureSize=function(t){if(this.buffer.length<this.position+t){if(!this.allowResize)throw new RangeError("index out of range");var e=new Buffer(this.position+t);this.buffer.copy(e,0,0,this.buffer.length),this.buffer=e}},n(p,v),p.Z=function(t,e,r,i){var n=new p(t,e,r,void 0,i);return n.hasZ=!0,n},p.M=function(t,e,r,i){var n=new p(t,e,void 0,r,i);return n.hasM=!0,n},p.ZM=function(t,e,r,i,n){var o=new p(t,e,r,i,n);return o.hasZ=!0,o.hasM=!0,o},p._parseWkt=function(t,e){var r=new p;if(r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM,t.isMatch(["EMPTY"]))return r;t.expectGroupStart();var i=t.matchCoordinate(e);return r.x=i.x,r.y=i.y,r.z=i.z,r.m=i.m,t.expectGroupEnd(),r},p._parseWkb=function(t,e){var r=p._readWkbPoint(t,e);return r.srid=e.srid,r},p._readWkbPoint=function(t,e){return new p(t.readDouble(),t.readDouble(),e.hasZ?t.readDouble():void 0,e.hasM?t.readDouble():void 0)},p._parseTwkb=function(t,e){var r=new p;return r.hasZ=e.hasZ,r.hasM=e.hasM,e.isEmpty?r:(r.x=h(t.readVarInt())/e.precisionFactor,r.y=h(t.readVarInt())/e.precisionFactor,r.z=e.hasZ?h(t.readVarInt())/e.zPrecisionFactor:void 0,r.m=e.hasM?h(t.readVarInt())/e.mPrecisionFactor:void 0,r)},p._readTwkbPoint=function(t,e,r){return r.x+=h(t.readVarInt())/e.precisionFactor,r.y+=h(t.readVarInt())/e.precisionFactor,e.hasZ&&(r.z+=h(t.readVarInt())/e.zPrecisionFactor),e.hasM&&(r.m+=h(t.readVarInt())/e.mPrecisionFactor),new p(r.x,r.y,r.z,r.m)},p._parseGeoJSON=function(t){return p._readGeoJSONPoint(t.coordinates)},p._readGeoJSONPoint=function(t){return 0===t.length?new p:t.length>2?new p(t[0],t[1],t[2]):new p(t[0],t[1])},p.prototype.toWkt=function(){return void 0===this.x&&void 0===this.y&&void 0===this.z&&void 0===this.m?this._getWktType(e.Point,!0):this._getWktType(e.Point,!1)+"("+this._getWktCoordinate(this)+")"},p.prototype.toWkb=function(t){var e=new o(this._getWkbSize());return e.writeInt8(1),this._writeWkbType(e,r.Point,t),void 0===this.x&&void 0===this.y?(e.writeDoubleLE(NaN),e.writeDoubleLE(NaN),this.hasZ&&e.writeDoubleLE(NaN),this.hasM&&e.writeDoubleLE(NaN)):this._writeWkbPoint(e),e.buffer},p.prototype._writeWkbPoint=function(t){t.writeDoubleLE(this.x),t.writeDoubleLE(this.y),this.hasZ&&t.writeDoubleLE(this.z),this.hasM&&t.writeDoubleLE(this.m)},p.prototype.toTwkb=function(){var t=new o(0,!0),e=v.getTwkbPrecision(5,0,0),i=void 0===this.x&&void 0===this.y;return this._writeTwkbHeader(t,r.Point,e,i),i||this._writeTwkbPoint(t,e,new p(0,0,0,0)),t.buffer},p.prototype._writeTwkbPoint=function(t,e,r){var i=this.x*e.xyFactor,n=this.y*e.xyFactor,o=this.z*e.zFactor,s=this.m*e.mFactor;t.writeVarInt(a(i-r.x)),t.writeVarInt(a(n-r.y)),this.hasZ&&t.writeVarInt(a(o-r.z)),this.hasM&&t.writeVarInt(a(s-r.m)),r.x=i,r.y=n,r.z=o,r.m=s},p.prototype._getWkbSize=function(){var t=21;return this.hasZ&&(t+=8),this.hasM&&(t+=8),t},p.prototype.toGeoJSON=function(t){var e=v.prototype.toGeoJSON.call(this,t);return e.type=i.Point,void 0===this.x&&void 0===this.y?e.coordinates=[]:void 0!==this.z?e.coordinates=[this.x,this.y,this.z]:e.coordinates=[this.x,this.y],e},n(u,v),u.Z=function(t,e){var r=new u(t,e);return r.hasZ=!0,r},u.M=function(t,e){var r=new u(t,e);return r.hasM=!0,r},u.ZM=function(t,e){var r=new u(t,e);return r.hasZ=!0,r.hasM=!0,r},u._parseWkt=function(t,e){var r=new u;return r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM,t.isMatch(["EMPTY"])?r:(t.expectGroupStart(),r.points.push.apply(r.points,t.matchCoordinates(e)),t.expectGroupEnd(),r)},u._parseWkb=function(t,e){var r=new u;r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM;for(var i=t.readUInt32(),n=0;n<i;n++)r.points.push(p._readWkbPoint(t,e));return r},u._parseTwkb=function(t,e){var r=new u;if(r.hasZ=e.hasZ,r.hasM=e.hasM,e.isEmpty)return r;for(var i=new p(0,0,e.hasZ?0:void 0,e.hasM?0:void 0),n=t.readVarInt(),o=0;o<n;o++)r.points.push(p._readTwkbPoint(t,e,i));return r},u._parseGeoJSON=function(t){var e=new u;t.coordinates.length>0&&(e.hasZ=t.coordinates[0].length>2);for(var r=0;r<t.coordinates.length;r++)e.points.push(p._readGeoJSONPoint(t.coordinates[r]));return e},u.prototype.toWkt=function(){return 0===this.points.length?this._getWktType(e.LineString,!0):this._getWktType(e.LineString,!1)+this._toInnerWkt()},u.prototype._toInnerWkt=function(){for(var t="(",e=0;e<this.points.length;e++)t+=this._getWktCoordinate(this.points[e])+",";return t=t.slice(0,-1),t+=")"},u.prototype.toWkb=function(t){var e=new o(this._getWkbSize());e.writeInt8(1),this._writeWkbType(e,r.LineString,t),e.writeUInt32LE(this.points.length);for(var i=0;i<this.points.length;i++)this.points[i]._writeWkbPoint(e);return e.buffer},u.prototype.toTwkb=function(){var t=new o(0,!0),e=v.getTwkbPrecision(5,0,0),i=0===this.points.length;if(this._writeTwkbHeader(t,r.LineString,e,i),this.points.length>0){t.writeVarInt(this.points.length);for(var n=new p(0,0,0,0),s=0;s<this.points.length;s++)this.points[s]._writeTwkbPoint(t,e,n)}return t.buffer},u.prototype._getWkbSize=function(){var t=16;return this.hasZ&&(t+=8),this.hasM&&(t+=8),9+this.points.length*t},u.prototype.toGeoJSON=function(t){var e=v.prototype.toGeoJSON.call(this,t);e.type=i.LineString,e.coordinates=[];for(var r=0;r<this.points.length;r++)this.hasZ?e.coordinates.push([this.points[r].x,this.points[r].y,this.points[r].z]):e.coordinates.push([this.points[r].x,this.points[r].y]);return e},n(c,v),c.Z=function(t,e,r){var i=new c(t,e,r);return i.hasZ=!0,i},c.M=function(t,e,r){var i=new c(t,e,r);return i.hasM=!0,i},c.ZM=function(t,e,r){var i=new c(t,e,r);return i.hasZ=!0,i.hasM=!0,i},c._parseWkt=function(t,e){var r=new c;if(r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM,t.isMatch(["EMPTY"]))return r;for(t.expectGroupStart(),t.expectGroupStart(),r.exteriorRing.push.apply(r.exteriorRing,t.matchCoordinates(e)),t.expectGroupEnd();t.isMatch([","]);)t.expectGroupStart(),r.interiorRings.push(t.matchCoordinates(e)),t.expectGroupEnd();return t.expectGroupEnd(),r},c._parseWkb=function(t,e){var r=new c;r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM;var i=t.readUInt32();if(i>0){for(var n=t.readUInt32(),o=0;o<n;o++)r.exteriorRing.push(p._readWkbPoint(t,e));for(o=1;o<i;o++){for(var s=[],a=t.readUInt32(),h=0;h<a;h++)s.push(p._readWkbPoint(t,e));r.interiorRings.push(s)}}return r},c._parseTwkb=function(t,e){var r=new c;if(r.hasZ=e.hasZ,r.hasM=e.hasM,e.isEmpty)return r;for(var i=new p(0,0,e.hasZ?0:void 0,e.hasM?0:void 0),n=t.readVarInt(),o=t.readVarInt(),s=0;s<o;s++)r.exteriorRing.push(p._readTwkbPoint(t,e,i));for(s=1;s<n;s++){for(var a=[],h=t.readVarInt(),u=0;u<h;u++)a.push(p._readTwkbPoint(t,e,i));r.interiorRings.push(a)}return r},c._parseGeoJSON=function(t){var e=new c;t.coordinates.length>0&&t.coordinates[0].length>0&&(e.hasZ=t.coordinates[0][0].length>2);for(var r=0;r<t.coordinates.length;r++){r>0&&e.interiorRings.push([]);for(var i=0;i<t.coordinates[r].length;i++)0===r?e.exteriorRing.push(p._readGeoJSONPoint(t.coordinates[r][i])):e.interiorRings[r-1].push(p._readGeoJSONPoint(t.coordinates[r][i]))}return e},c.prototype.toWkt=function(){return 0===this.exteriorRing.length?this._getWktType(e.Polygon,!0):this._getWktType(e.Polygon,!1)+this._toInnerWkt()},c.prototype._toInnerWkt=function(){for(var t="((",e=0;e<this.exteriorRing.length;e++)t+=this._getWktCoordinate(this.exteriorRing[e])+",";for(t=t.slice(0,-1),t+=")",e=0;e<this.interiorRings.length;e++){t+=",(";for(var r=0;r<this.interiorRings[e].length;r++)t+=this._getWktCoordinate(this.interiorRings[e][r])+",";t=t.slice(0,-1),t+=")"}return t+=")"},c.prototype.toWkb=function(t){var e=new o(this._getWkbSize());e.writeInt8(1),this._writeWkbType(e,r.Polygon,t),this.exteriorRing.length>0?(e.writeUInt32LE(1+this.interiorRings.length),e.writeUInt32LE(this.exteriorRing.length)):e.writeUInt32LE(0);for(var i=0;i<this.exteriorRing.length;i++)this.exteriorRing[i]._writeWkbPoint(e);for(i=0;i<this.interiorRings.length;i++){e.writeUInt32LE(this.interiorRings[i].length);for(var n=0;n<this.interiorRings[i].length;n++)this.interiorRings[i][n]._writeWkbPoint(e)}return e.buffer},c.prototype.toTwkb=function(){var t=new o(0,!0),e=v.getTwkbPrecision(5,0,0),i=0===this.exteriorRing.length;if(this._writeTwkbHeader(t,r.Polygon,e,i),this.exteriorRing.length>0){t.writeVarInt(1+this.interiorRings.length),t.writeVarInt(this.exteriorRing.length);for(var n=new p(0,0,0,0),s=0;s<this.exteriorRing.length;s++)this.exteriorRing[s]._writeTwkbPoint(t,e,n);for(s=0;s<this.interiorRings.length;s++){t.writeVarInt(this.interiorRings[s].length);for(var a=0;a<this.interiorRings[s].length;a++)this.interiorRings[s][a]._writeTwkbPoint(t,e,n)}}return t.buffer},c.prototype._getWkbSize=function(){var t=16;this.hasZ&&(t+=8),this.hasM&&(t+=8);var e=9;this.exteriorRing.length>0&&(e+=4+this.exteriorRing.length*t);for(var r=0;r<this.interiorRings.length;r++)e+=4+this.interiorRings[r].length*t;return e},c.prototype.toGeoJSON=function(t){var e=v.prototype.toGeoJSON.call(this,t);if(e.type=i.Polygon,e.coordinates=[],this.exteriorRing.length>0){for(var r=[],n=0;n<this.exteriorRing.length;n++)this.hasZ?r.push([this.exteriorRing[n].x,this.exteriorRing[n].y,this.exteriorRing[n].z]):r.push([this.exteriorRing[n].x,this.exteriorRing[n].y]);e.coordinates.push(r)}for(var o=0;o<this.interiorRings.length;o++){for(var s=[],a=0;a<this.interiorRings[o].length;a++)this.hasZ?s.push([this.interiorRings[o][a].x,this.interiorRings[o][a].y,this.interiorRings[o][a].z]):s.push([this.interiorRings[o][a].x,this.interiorRings[o][a].y]);e.coordinates.push(s)}return e},n(f,v),f.Z=function(t,e){var r=new f(t,e);return r.hasZ=!0,r},f.M=function(t,e){var r=new f(t,e);return r.hasM=!0,r},f.ZM=function(t,e){var r=new f(t,e);return r.hasZ=!0,r.hasM=!0,r},f._parseWkt=function(t,e){var r=new f;return r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM,t.isMatch(["EMPTY"])?r:(t.expectGroupStart(),r.points.push.apply(r.points,t.matchCoordinates(e)),t.expectGroupEnd(),r)},f._parseWkb=function(t,e){var r=new f;r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM;for(var i=t.readUInt32(),n=0;n<i;n++)r.points.push(v.parse(t,e));return r},f._parseTwkb=function(t,e){var r=new f;if(r.hasZ=e.hasZ,r.hasM=e.hasM,e.isEmpty)return r;for(var i=new p(0,0,e.hasZ?0:void 0,e.hasM?0:void 0),n=t.readVarInt(),o=0;o<n;o++)r.points.push(p._readTwkbPoint(t,e,i));return r},f._parseGeoJSON=function(t){var e=new f;t.coordinates.length>0&&(e.hasZ=t.coordinates[0].length>2);for(var r=0;r<t.coordinates.length;r++)e.points.push(p._parseGeoJSON({coordinates:t.coordinates[r]}));return e},f.prototype.toWkt=function(){if(0===this.points.length)return this._getWktType(e.MultiPoint,!0);for(var t=this._getWktType(e.MultiPoint,!1)+"(",r=0;r<this.points.length;r++)t+=this._getWktCoordinate(this.points[r])+",";return t=t.slice(0,-1),t+=")"},f.prototype.toWkb=function(){var t=new o(this._getWkbSize());t.writeInt8(1),this._writeWkbType(t,r.MultiPoint),t.writeUInt32LE(this.points.length);for(var e=0;e<this.points.length;e++)t.writeBuffer(this.points[e].toWkb({srid:this.srid}));return t.buffer},f.prototype.toTwkb=function(){var t=new o(0,!0),e=v.getTwkbPrecision(5,0,0),i=0===this.points.length;if(this._writeTwkbHeader(t,r.MultiPoint,e,i),this.points.length>0){t.writeVarInt(this.points.length);for(var n=new p(0,0,0,0),s=0;s<this.points.length;s++)this.points[s]._writeTwkbPoint(t,e,n)}return t.buffer},f.prototype._getWkbSize=function(){var t=16;return this.hasZ&&(t+=8),this.hasM&&(t+=8),t+=5,9+this.points.length*t},f.prototype.toGeoJSON=function(t){var e=v.prototype.toGeoJSON.call(this,t);e.type=i.MultiPoint,e.coordinates=[];for(var r=0;r<this.points.length;r++)e.coordinates.push(this.points[r].toGeoJSON().coordinates);return e},n(g,v),g.Z=function(t,e){var r=new g(t,e);return r.hasZ=!0,r},g.M=function(t,e){var r=new g(t,e);return r.hasM=!0,r},g.ZM=function(t,e){var r=new g(t,e);return r.hasZ=!0,r.hasM=!0,r},g._parseWkt=function(t,e){var r=new g;if(r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM,t.isMatch(["EMPTY"]))return r;t.expectGroupStart();do{t.expectGroupStart(),r.lineStrings.push(new u(t.matchCoordinates(e))),t.expectGroupEnd()}while(t.isMatch([","]));return t.expectGroupEnd(),r},g._parseWkb=function(t,e){var r=new g;r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM;for(var i=t.readUInt32(),n=0;n<i;n++)r.lineStrings.push(v.parse(t,e));return r},g._parseTwkb=function(t,e){var r=new g;if(r.hasZ=e.hasZ,r.hasM=e.hasM,e.isEmpty)return r;for(var i=new p(0,0,e.hasZ?0:void 0,e.hasM?0:void 0),n=t.readVarInt(),o=0;o<n;o++){var s=new u;s.hasZ=e.hasZ,s.hasM=e.hasM;for(var a=t.readVarInt(),h=0;h<a;h++)s.points.push(p._readTwkbPoint(t,e,i));r.lineStrings.push(s)}return r},g._parseGeoJSON=function(t){var e=new g;t.coordinates.length>0&&t.coordinates[0].length>0&&(e.hasZ=t.coordinates[0][0].length>2);for(var r=0;r<t.coordinates.length;r++)e.lineStrings.push(u._parseGeoJSON({coordinates:t.coordinates[r]}));return e},g.prototype.toWkt=function(){if(0===this.lineStrings.length)return this._getWktType(e.MultiLineString,!0);for(var t=this._getWktType(e.MultiLineString,!1)+"(",r=0;r<this.lineStrings.length;r++)t+=this.lineStrings[r]._toInnerWkt()+",";return t=t.slice(0,-1),t+=")"},g.prototype.toWkb=function(){var t=new o(this._getWkbSize());t.writeInt8(1),this._writeWkbType(t,r.MultiLineString),t.writeUInt32LE(this.lineStrings.length);for(var e=0;e<this.lineStrings.length;e++)t.writeBuffer(this.lineStrings[e].toWkb({srid:this.srid}));return t.buffer},g.prototype.toTwkb=function(){var t=new o(0,!0),e=v.getTwkbPrecision(5,0,0),i=0===this.lineStrings.length;if(this._writeTwkbHeader(t,r.MultiLineString,e,i),this.lineStrings.length>0){t.writeVarInt(this.lineStrings.length);for(var n=new p(0,0,0,0),s=0;s<this.lineStrings.length;s++){t.writeVarInt(this.lineStrings[s].points.length);for(var a=0;a<this.lineStrings[s].points.length;a++)this.lineStrings[s].points[a]._writeTwkbPoint(t,e,n)}}return t.buffer},g.prototype._getWkbSize=function(){for(var t=9,e=0;e<this.lineStrings.length;e++)t+=this.lineStrings[e]._getWkbSize();return t},g.prototype.toGeoJSON=function(t){var e=v.prototype.toGeoJSON.call(this,t);e.type=i.MultiLineString,e.coordinates=[];for(var r=0;r<this.lineStrings.length;r++)e.coordinates.push(this.lineStrings[r].toGeoJSON().coordinates);return e},n(l,v),l.Z=function(t,e){var r=new l(t,e);return r.hasZ=!0,r},l.M=function(t,e){var r=new l(t,e);return r.hasM=!0,r},l.ZM=function(t,e){var r=new l(t,e);return r.hasZ=!0,r.hasM=!0,r},l._parseWkt=function(t,e){var r=new l;if(r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM,t.isMatch(["EMPTY"]))return r;t.expectGroupStart();do{t.expectGroupStart();var i=[],n=[];for(t.expectGroupStart(),i.push.apply(i,t.matchCoordinates(e)),t.expectGroupEnd();t.isMatch([","]);)t.expectGroupStart(),n.push(t.matchCoordinates(e)),t.expectGroupEnd();r.polygons.push(new c(i,n)),t.expectGroupEnd()}while(t.isMatch([","]));return t.expectGroupEnd(),r},l._parseWkb=function(t,e){var r=new l;r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM;for(var i=t.readUInt32(),n=0;n<i;n++)r.polygons.push(v.parse(t,e));return r},l._parseTwkb=function(t,e){var r=new l;if(r.hasZ=e.hasZ,r.hasM=e.hasM,e.isEmpty)return r;for(var i=new p(0,0,e.hasZ?0:void 0,e.hasM?0:void 0),n=t.readVarInt(),o=0;o<n;o++){var s=new c;s.hasZ=e.hasZ,s.hasM=e.hasM;for(var a=t.readVarInt(),h=t.readVarInt(),u=0;u<h;u++)s.exteriorRing.push(p._readTwkbPoint(t,e,i));for(u=1;u<a;u++){for(var f=[],g=t.readVarInt(),d=0;d<g;d++)f.push(p._readTwkbPoint(t,e,i));s.interiorRings.push(f)}r.polygons.push(s)}return r},l._parseGeoJSON=function(t){var e=new l;t.coordinates.length>0&&t.coordinates[0].length>0&&t.coordinates[0][0].length>0&&(e.hasZ=t.coordinates[0][0][0].length>2);for(var r=0;r<t.coordinates.length;r++)e.polygons.push(c._parseGeoJSON({coordinates:t.coordinates[r]}));return e},l.prototype.toWkt=function(){if(0===this.polygons.length)return this._getWktType(e.MultiPolygon,!0);for(var t=this._getWktType(e.MultiPolygon,!1)+"(",r=0;r<this.polygons.length;r++)t+=this.polygons[r]._toInnerWkt()+",";return t=t.slice(0,-1),t+=")"},l.prototype.toWkb=function(){var t=new o(this._getWkbSize());t.writeInt8(1),this._writeWkbType(t,r.MultiPolygon),t.writeUInt32LE(this.polygons.length);for(var e=0;e<this.polygons.length;e++)t.writeBuffer(this.polygons[e].toWkb({srid:this.srid}));return t.buffer},l.prototype.toTwkb=function(){var t=new o(0,!0),e=v.getTwkbPrecision(5,0,0),i=0===this.polygons.length;if(this._writeTwkbHeader(t,r.MultiPolygon,e,i),this.polygons.length>0){t.writeVarInt(this.polygons.length);for(var n=new p(0,0,0,0),s=0;s<this.polygons.length;s++){t.writeVarInt(1+this.polygons[s].interiorRings.length),t.writeVarInt(this.polygons[s].exteriorRing.length);for(var a=0;a<this.polygons[s].exteriorRing.length;a++)this.polygons[s].exteriorRing[a]._writeTwkbPoint(t,e,n);for(a=0;a<this.polygons[s].interiorRings.length;a++){t.writeVarInt(this.polygons[s].interiorRings[a].length);for(var h=0;h<this.polygons[s].interiorRings[a].length;h++)this.polygons[s].interiorRings[a][h]._writeTwkbPoint(t,e,n)}}}return t.buffer},l.prototype._getWkbSize=function(){for(var t=9,e=0;e<this.polygons.length;e++)t+=this.polygons[e]._getWkbSize();return t},l.prototype.toGeoJSON=function(t){var e=v.prototype.toGeoJSON.call(this,t);e.type=i.MultiPolygon,e.coordinates=[];for(var r=0;r<this.polygons.length;r++)e.coordinates.push(this.polygons[r].toGeoJSON().coordinates);return e},n(d,v),d.Z=function(t,e){var r=new d(t,e);return r.hasZ=!0,r},d.M=function(t,e){var r=new d(t,e);return r.hasM=!0,r},d.ZM=function(t,e){var r=new d(t,e);return r.hasZ=!0,r.hasM=!0,r},d._parseWkt=function(t,e){var r=new d;if(r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM,t.isMatch(["EMPTY"]))return r;t.expectGroupStart();do{r.geometries.push(v.parse(t))}while(t.isMatch([","]));return t.expectGroupEnd(),r},d._parseWkb=function(t,e){var r=new d;r.srid=e.srid,r.hasZ=e.hasZ,r.hasM=e.hasM;for(var i=t.readUInt32(),n=0;n<i;n++)r.geometries.push(v.parse(t,e));return r},d._parseTwkb=function(t,e){var r=new d;if(r.hasZ=e.hasZ,r.hasM=e.hasM,e.isEmpty)return r;for(var i=t.readVarInt(),n=0;n<i;n++)r.geometries.push(v.parseTwkb(t));return r},d._parseGeoJSON=function(t){for(var e=new d,r=0;r<t.geometries.length;r++)e.geometries.push(v._parseGeoJSON(t.geometries[r],!0));return e.geometries.length>0&&(e.hasZ=e.geometries[0].hasZ),e},d.prototype.toWkt=function(){if(0===this.geometries.length)return this._getWktType(e.GeometryCollection,!0);for(var t=this._getWktType(e.GeometryCollection,!1)+"(",r=0;r<this.geometries.length;r++)t+=this.geometries[r].toWkt()+",";return t=t.slice(0,-1),t+=")"},d.prototype.toWkb=function(){var t=new o(this._getWkbSize());t.writeInt8(1),this._writeWkbType(t,r.GeometryCollection),t.writeUInt32LE(this.geometries.length);for(var e=0;e<this.geometries.length;e++)t.writeBuffer(this.geometries[e].toWkb({srid:this.srid}));return t.buffer},d.prototype.toTwkb=function(){var t=new o(0,!0),e=v.getTwkbPrecision(5,0,0),i=0===this.geometries.length;if(this._writeTwkbHeader(t,r.GeometryCollection,e,i),this.geometries.length>0){t.writeVarInt(this.geometries.length);for(var n=0;n<this.geometries.length;n++)t.writeBuffer(this.geometries[n].toTwkb())}return t.buffer},d.prototype._getWkbSize=function(){for(var t=9,e=0;e<this.geometries.length;e++)t+=this.geometries[e]._getWkbSize();return t},d.prototype.toGeoJSON=function(t){var e=v.prototype.toGeoJSON.call(this,t);e.type=i.GeometryCollection,e.geometries=[];for(var r=0;r<this.geometries.length;r++)e.geometries.push(this.geometries[r].toGeoJSON());return e},w.prototype.readUInt8=y(Buffer.prototype.readUInt8,Buffer.prototype.readUInt8,1),w.prototype.readUInt16=y(Buffer.prototype.readUInt16LE,Buffer.prototype.readUInt16BE,2),w.prototype.readUInt32=y(Buffer.prototype.readUInt32LE,Buffer.prototype.readUInt32BE,4),w.prototype.readInt8=y(Buffer.prototype.readInt8,Buffer.prototype.readInt8,1),w.prototype.readInt16=y(Buffer.prototype.readInt16LE,Buffer.prototype.readInt16BE,2),w.prototype.readInt32=y(Buffer.prototype.readInt32LE,Buffer.prototype.readInt32BE,4),w.prototype.readFloat=y(Buffer.prototype.readFloatLE,Buffer.prototype.readFloatBE,4),w.prototype.readDouble=y(Buffer.prototype.readDoubleLE,Buffer.prototype.readDoubleBE,8),w.prototype.readVarInt=function(){var t,e=0,r=0;do{e+=(127&(t=this.buffer[this.position+r]))<<7*r,r++}while(t>=128);return this.position+=r,e},M.prototype.match=function(t){this.skipWhitespaces();for(var e=0;e<t.length;e++)if(0===this.value.substring(this.position).indexOf(t[e]))return this.position+=t[e].length,t[e];return null},M.prototype.matchRegex=function(t){this.skipWhitespaces();for(var e=0;e<t.length;e++){var r=this.value.substring(this.position).match(t[e]);if(r)return this.position+=r[0].length,r}return null},M.prototype.isMatch=function(t){this.skipWhitespaces();for(var e=0;e<t.length;e++)if(0===this.value.substring(this.position).indexOf(t[e]))return this.position+=t[e].length,!0;return!1},M.prototype.matchType=function(){var t=this.match([e.Point,e.LineString,e.Polygon,e.MultiPoint,e.MultiLineString,e.MultiPolygon,e.GeometryCollection]);if(!t)throw new Error("Expected geometry type");return t},M.prototype.matchDimension=function(){switch(this.match(["ZM","Z","M"])){case"ZM":return{hasZ:!0,hasM:!0};case"Z":return{hasZ:!0,hasM:!1};case"M":return{hasZ:!1,hasM:!0};default:return{hasZ:!1,hasM:!1}}},M.prototype.expectGroupStart=function(){if(!this.isMatch(["("]))throw new Error("Expected group start")},M.prototype.expectGroupEnd=function(){if(!this.isMatch([")"]))throw new Error("Expected group end")},M.prototype.matchCoordinate=function(t){var e;if(!(e=t.hasZ&&t.hasM?this.matchRegex([/^(\S*)\s+(\S*)\s+(\S*)\s+([^\s,)]*)/]):t.hasZ||t.hasM?this.matchRegex([/^(\S*)\s+(\S*)\s+([^\s,)]*)/]):this.matchRegex([/^(\S*)\s+([^\s,)]*)/])))throw new Error("Expected coordinates");return t.hasZ&&t.hasM?new p(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3]),parseFloat(e[4])):t.hasZ?new p(parseFloat(e[1]),parseFloat(e[2]),parseFloat(e[3])):t.hasM?new p(parseFloat(e[1]),parseFloat(e[2]),void 0,parseFloat(e[3])):new p(parseFloat(e[1]),parseFloat(e[2]))},M.prototype.matchCoordinates=function(t){var e=[];do{var r=this.isMatch(["("]);e.push(this.matchCoordinate(t)),r&&this.expectGroupEnd()}while(this.isMatch([","]));return e},M.prototype.skipWhitespaces=function(){for(;this.position<this.value.length&&" "===this.value[this.position];)this.position++},v.parse=function(t,e){if("string"===typeof t||t instanceof M)return v._parseWkt(t);if(Buffer.isBuffer(t)||t instanceof w)return v._parseWkb(t,e);throw new Error("first argument must be a string or Buffer")},v._parseWkt=function(t){var r,i,n=(r=t instanceof M?t:new M(t)).matchRegex([/^SRID=(\d+);/]);n&&(i=parseInt(n[1],10));var o=r.matchType(),s=r.matchDimension(),a={srid:i,hasZ:s.hasZ,hasM:s.hasM};switch(o){case e.Point:return p._parseWkt(r,a);case e.LineString:return u._parseWkt(r,a);case e.Polygon:return c._parseWkt(r,a);case e.MultiPoint:return f._parseWkt(r,a);case e.MultiLineString:return g._parseWkt(r,a);case e.MultiPolygon:return l._parseWkt(r,a);case e.GeometryCollection:return d._parseWkt(r,a)}},v._parseWkb=function(t,e){var i,n,o,s={};switch((i=t instanceof w?t:new w(t)).isBigEndian=!i.readInt8(),n=i.readUInt32(),s.hasSrid=536870912==(536870912&n),s.isEwkb=536870912&n||1073741824&n||2147483648&n,s.hasSrid&&(s.srid=i.readUInt32()),s.hasZ=!1,s.hasM=!1,s.isEwkb||e&&e.isEwkb?(2147483648&n&&(s.hasZ=!0),1073741824&n&&(s.hasM=!0),o=15&n):n>=1e3&&n<2e3?(s.hasZ=!0,o=n-1e3):n>=2e3&&n<3e3?(s.hasM=!0,o=n-2e3):n>=3e3&&n<4e3?(s.hasZ=!0,s.hasM=!0,o=n-3e3):o=n,o){case r.Point:return p._parseWkb(i,s);case r.LineString:return u._parseWkb(i,s);case r.Polygon:return c._parseWkb(i,s);case r.MultiPoint:return f._parseWkb(i,s);case r.MultiLineString:return g._parseWkb(i,s);case r.MultiPolygon:return l._parseWkb(i,s);case r.GeometryCollection:return d._parseWkb(i,s);default:throw new Error("GeometryType "+o+" not supported")}},v.parseTwkb=function(t){var e,i={},n=(e=t instanceof w?t:new w(t)).readUInt8(),o=e.readUInt8(),s=15&n;if(i.precision=h(n>>4),i.precisionFactor=Math.pow(10,i.precision),i.hasBoundingBox=o>>0&1,i.hasSizeAttribute=o>>1&1,i.hasIdList=o>>2&1,i.hasExtendedPrecision=o>>3&1,i.isEmpty=o>>4&1,i.hasExtendedPrecision){var a=e.readUInt8();i.hasZ=1==(1&a),i.hasM=2==(2&a),i.zPrecision=h((28&a)>>2),i.zPrecisionFactor=Math.pow(10,i.zPrecision),i.mPrecision=h((224&a)>>5),i.mPrecisionFactor=Math.pow(10,i.mPrecision)}else i.hasZ=!1,i.hasM=!1;if(i.hasSizeAttribute&&e.readVarInt(),i.hasBoundingBox){var y=2;i.hasZ&&y++,i.hasM&&y++;for(var M=0;M<y;M++)e.readVarInt(),e.readVarInt()}switch(s){case r.Point:return p._parseTwkb(e,i);case r.LineString:return u._parseTwkb(e,i);case r.Polygon:return c._parseTwkb(e,i);case r.MultiPoint:return f._parseTwkb(e,i);case r.MultiLineString:return g._parseTwkb(e,i);case r.MultiPolygon:return l._parseTwkb(e,i);case r.GeometryCollection:return d._parseTwkb(e,i);default:throw new Error("GeometryType "+s+" not supported")}},v.parseGeoJSON=function(t){return v._parseGeoJSON(t)},v._parseGeoJSON=function(t,e){var r;switch(t.type){case i.Point:r=p._parseGeoJSON(t);break;case i.LineString:r=u._parseGeoJSON(t);break;case i.Polygon:r=c._parseGeoJSON(t);break;case i.MultiPoint:r=f._parseGeoJSON(t);break;case i.MultiLineString:r=g._parseGeoJSON(t);break;case i.MultiPolygon:r=l._parseGeoJSON(t);break;case i.GeometryCollection:r=d._parseGeoJSON(t);break;default:throw new Error("GeometryType "+t.type+" not supported")}if(t.crs&&t.crs.type&&"name"===t.crs.type&&t.crs.properties&&t.crs.properties.name){var n=t.crs.properties.name;if(0===n.indexOf("EPSG:"))r.srid=parseInt(n.substring(5));else{if(0!==n.indexOf("urn:ogc:def:crs:EPSG::"))throw new Error("Unsupported crs: "+n);r.srid=parseInt(n.substring(22))}}else e||(r.srid=4326);return r},v.prototype.toEwkt=function(){return"SRID="+this.srid+";"+this.toWkt()},v.prototype.toEwkb=function(){var t=new o(this._getWkbSize()+4),e=this.toWkb();return t.writeInt8(1),t.writeUInt32LE((536870912|e.slice(1,5).readUInt32LE(0))>>>0,!0),t.writeUInt32LE(this.srid),t.writeBuffer(e.slice(5)),t.buffer},v.prototype._getWktType=function(t,e){var r=t;return this.hasZ&&this.hasM?r+=" ZM ":this.hasZ?r+=" Z ":this.hasM&&(r+=" M "),!e||this.hasZ||this.hasM||(r+=" "),e&&(r+="EMPTY"),r},v.prototype._getWktCoordinate=function(t){var e=t.x+" "+t.y;return this.hasZ&&(e+=" "+t.z),this.hasM&&(e+=" "+t.m),e},v.prototype._writeWkbType=function(t,e,r){var i=0;void 0!==this.srid||r&&void 0!==r.srid?(this.hasZ&&(i|=2147483648),this.hasM&&(i|=1073741824)):this.hasZ&&this.hasM?i+=3e3:this.hasZ?i+=1e3:this.hasM&&(i+=2e3),t.writeUInt32LE(i+e>>>0,!0)},v.getTwkbPrecision=function(t,e,r){return{xy:t,z:e,m:r,xyFactor:Math.pow(10,t),zFactor:Math.pow(10,e),mFactor:Math.pow(10,r)}},v.prototype._writeTwkbHeader=function(t,e,r,i){var n=(a(r.xy)<<4)+e,o=(this.hasZ||this.hasM)<<3;if(o+=i<<4,t.writeUInt8(n),t.writeUInt8(o),this.hasZ||this.hasM){var s=0;this.hasZ&&(s|=1),this.hasM&&(s|=2),t.writeUInt8(s)}},v.prototype.toGeoJSON=function(t){var e={};return this.srid&&t&&(t.shortCrs?e.crs={type:"name",properties:{name:"EPSG:"+this.srid}}:t.longCrs&&(e.crs={type:"name",properties:{name:"urn:ogc:def:crs:EPSG::"+this.srid}})),e},t.Geometry=v,t.Point=p,t.LineString=u,t.Polygon=c,t.MultiPoint=f,t.MultiLineString=g,t.MultiPolygon=l,t.GeometryCollection=d,t.wkt=e,t.wkb=r,t.geoJSON=i,Object.defineProperty(t,"__esModule",{value:!0})});
